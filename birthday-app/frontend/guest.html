<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy birthday to me</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* æ·»åŠ å±…ä¸­æ ·å¼ */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .container button {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ‰ ç•™ä¸‹ä½ çš„ç¥ç¦ ğŸ‚</h1>

    <input type="text" id="name" placeholder="ä½ çš„åå­—ï¼ˆå¿…å¡«ï¼‰" maxlength="20" required>
    <input type="text" id="message" placeholder="å†™ä¸‹ç¥ç¦è¯­...ï¼ˆæœ€å¤š50å­—ï¼‰" maxlength="50" required>

    <button onclick="saveGreeting()">ğŸ’Œ å‘é€ç¥ç¦</button>

    <div id="loading" style="display: none; color: #ff4d94; margin: 10px 0;">
        <span>åŠ è½½ä¸­...</span>
    </div>

    <ul id="greetings-list" style="list-style: none; padding: 0; margin-top: 20px;"></ul>
</div>

<script>
// è·å–å½“å‰ç”¨æˆ·çš„åå­—
function getUserId() {
    return localStorage.getItem('username'); // ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–ç”¨æˆ·åå­—
}

// æ ¼å¼åŒ–æ—¶é—´å‡½æ•°
function formatDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
}

// æäº¤ç¥ç¦
async function saveGreeting() {
    const name = document.getElementById('name').value.trim();
    const message = document.getElementById('message').value.trim();

    if (!name || !message) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    // å­˜å‚¨ç”¨æˆ·åå­—åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('username', name);

    try {
        const response = await fetch('/greetings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, message })
        });

        if (response.ok) {
            document.getElementById('name').value = '';
            document.getElementById('message').value = '';
            await loadGreetings();
            alert('ğŸ‰ ç¥ç¦å‘é€æˆåŠŸï¼');
        } else {
            const errorData = await response.json();
            alert(`å‘é€å¤±è´¥: ${errorData.message}`);
        }
    } catch (error) {
        console.error('å‘é€å¤±è´¥:', error);
        alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
}

// åŠ è½½ç¥ç¦
async function loadGreetings() {
    const loading = document.getElementById('loading');

    try {
        loading.style.display = 'block';

        const response = await fetch('/greetings');
        const data = await response.json();

        const list = document.getElementById('greetings-list');
        const userId = getUserId();

        // åªæ˜¾ç¤ºå½“å‰ç”¨æˆ·å‘é€çš„ç¥ç¦
        const userGreetings = data.filter(g => g.name === userId);

        list.innerHTML = userGreetings.map(g => `
            <li style="background: #fff0f6; padding: 15px; margin: 10px 0; border-radius: 10px;
                        animation: fadeIn 0.5s ease-out;">
                <p>${g.message}</p>
                <div style="color: #666; font-size: 0.9em;">
                    ${formatDate(g.createdAt)} <!-- æ˜¾ç¤ºæ—¶é—´ -->
                </div>
            </li>
        `).join('');

        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»å‘é€è¿‡ç¥ç¦
        if (userId) {
            const hasSentGreeting = data.some(g => g.name === userId);
            if (hasSentGreeting) {
                document.getElementById('name').disabled = true;
                document.getElementById('message').disabled = true;
                document.querySelector('button[onclick="saveGreeting()"]').disabled = true;
                alert('ä½ å·²ç»å‘é€è¿‡ç¥ç¦äº†');
            }
        }
    } catch (error) {
        alert('åŠ è½½å¤±è´¥');
    } finally {
        loading.style.display = 'none';
    }
}

// åˆå§‹åŒ–åŠ è½½ç¥ç¦
loadGreetings();
</script>
</body>
</html>